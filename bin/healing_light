#!/usr/bin/env ruby

# resolve bin path, ignoring symlinks
require "pathname"
bin_file = Pathname.new(__FILE__).realpath

# add self to libpath
$:.unshift File.expand_path("../../lib", bin_file)

require 'healing_light'
require 'healing_light/cli'
require 'gli'

include GLI::App
include HealingLight::CLI

program_desc 'Come bathe in the healing light!'

flag [:s,:strip], default_value: 'LPD8806'
flag [:c,:count], default_value: 32
flag [:d,:dev], default_value: '/dev/spidev0.0'

desc "Do something to all lights at once"
command :all do |c|
  pre do |globals,command,opts,args|
    $strip = strip globals
    $strip.extend HealingLight::Control::All
  end
  c.command :on do |on|
    on.action { $strip.all_on(255,255,255) }
  end
  c.command :off do |off|
    off.action { $strip.all_off }
  end
end

desc "Chase a light down the strip"
command :chase do |c|
  pre do |globals,command,opts,args|
    $strip = strip globals
    $strip.extend HealingLight::Control::Chase
  end
  c.command :up do |up|
    up.action { $strip.chase_trailer(255,255,255,dir: :behind) }
  end
  c.command :down do |down|
    down.action { $strip.chase_trailer(255,255,255,dir: :ahead) }
  end
  c.command :up_down do |x|
    x.action do
      $strip.chase_trailer(128,0,0, dir: :behind)
      $strip.chase_trailer(0,128,0, dir: :ahead)
    end
  end
end

exit run(ARGV)

# vim ft=ruby
